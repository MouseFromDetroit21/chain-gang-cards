<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Chain Gang Poker</title>
<script src="/socket.io/socket.io.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { background:#080f08; color:#f0e6c8; font-family:Arial,sans-serif; min-height:100vh; overflow-x:hidden; }
#app { max-width:480px; margin:0 auto; padding:10px; }
.screen { display:none; }
.screen.active { display:block; }
.hdr { text-align:center; padding:14px 0 8px; }
.hdr h1 { font-size:2rem; font-weight:900; color:#d4a017; letter-spacing:4px; text-shadow:0 0 20px rgba(212,160,23,0.4); }
.hdr p { font-size:0.62rem; color:#666; letter-spacing:3px; margin-top:2px; }
.auth-box { background:#0d0d0d; border:1px solid #2a2a2a; border-radius:12px; padding:20px; margin-top:10px; }
.auth-box h2 { color:#d4a017; font-size:1.1rem; letter-spacing:2px; margin-bottom:16px; text-align:center; }
.field { margin-bottom:12px; }
.field label { display:block; font-size:0.7rem; color:#888; letter-spacing:1px; margin-bottom:4px; }
.field input { width:100%; background:#111; border:1px solid #333; color:#f0e6c8; font-size:0.95rem; padding:10px 12px; border-radius:8px; outline:none; }
.field input:focus { border-color:#d4a017; }
.btn { font-weight:700; font-size:0.85rem; letter-spacing:1px; padding:11px 18px; border:none; border-radius:8px; cursor:pointer; transition:opacity 0.1s; width:100%; margin-bottom:8px; }
.btn:active { opacity:0.7; }
.btn-gold { background:#d4a017; color:#000; }
.btn-outline { background:transparent; color:#d4a017; border:1px solid #d4a017; }
.btn-green { background:#1a8a3a; color:#fff; }
.btn-red { background:#aa2211; color:#fff; }
.btn-blue { background:#1155aa; color:#fff; }
.btn-purple { background:#772299; color:#fff; }
.btn-gray { background:#222; color:#ccc; border:1px solid #333; }
.btn-teal { background:#117766; color:#fff; }
.btn-sm { padding:8px 14px; font-size:0.78rem; width:auto; margin-bottom:0; }
.err { color:#ff6644; font-size:0.75rem; margin-top:6px; text-align:center; }
.toggle-auth { text-align:center; font-size:0.75rem; color:#888; margin-top:12px; }
.toggle-auth a { color:#d4a017; cursor:pointer; text-decoration:underline; }
.avatar-grid { display:flex; flex-wrap:wrap; gap:8px; justify-content:center; margin:10px 0; }
.av-opt { font-size:1.8rem; padding:6px; border-radius:8px; border:2px solid transparent; cursor:pointer; }
.av-opt.selected { border-color:#d4a017; background:rgba(212,160,23,0.1); }
.lobby-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; flex-wrap:wrap; gap:8px; }
.user-pill { display:flex; align-items:center; gap:8px; background:#111; border:1px solid #2a2a2a; border-radius:20px; padding:6px 12px; }
.user-pill .av { font-size:1.4rem; }
.user-pill .uname { font-size:0.85rem; font-weight:700; }
.user-pill .uchips { font-size:0.7rem; color:#d4a017; }
.lobby-btns { display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.lobby-btn { background:#111; border:1px solid #2a2a2a; border-radius:10px; padding:16px; text-align:center; cursor:pointer; transition:border-color 0.2s; }
.lobby-btn:active { border-color:#d4a017; }
.lobby-btn .lbicon { font-size:2rem; margin-bottom:6px; }
.lobby-btn .lbtitle { font-size:1rem; font-weight:700; color:#d4a017; letter-spacing:2px; }
.lobby-btn .lbdesc { font-size:0.7rem; color:#666; margin-top:4px; }
.code-input-row { display:flex; gap:8px; }
.code-input { flex:1; background:#111; border:1px solid #333; color:#f0e6c8; font-size:1rem; padding:10px; border-radius:8px; outline:none; text-transform:uppercase; letter-spacing:3px; }
.game-chooser { background:#0d1a0d; border:1px solid #1a3a1a; border-radius:12px; padding:16px; margin-bottom:12px; }
.game-chooser h3 { color:#d4a017; font-size:0.8rem; letter-spacing:2px; margin-bottom:10px; text-align:center; }
.game-tabs { display:flex; gap:8px; }
.game-tab { flex:1; padding:10px; border-radius:8px; border:2px solid #2a2a2a; background:#111; text-align:center; cursor:pointer; }
.game-tab.active-tab { border-color:#d4a017; background:#1a1400; }
.game-tab.badugi-active { border-color:#22ccaa; background:#001a15; }
.game-tab .gt-icon { font-size:1.5rem; }
.game-tab .gt-name { font-size:0.75rem; font-weight:700; letter-spacing:1px; margin-top:4px; }
.waiting-box { background:#0d0d0d; border:1px solid #2a2a2a; border-radius:12px; padding:24px; text-align:center; margin-top:10px; }
.waiting-box .w-icon { font-size:2.5rem; margin-bottom:10px; }
.waiting-box h3 { color:#d4a017; letter-spacing:2px; margin-bottom:8px; }
.waiting-box p { color:#666; font-size:0.8rem; margin-bottom:10px; }
.private-code { font-size:2rem; font-weight:900; color:#d4a017; letter-spacing:8px; background:#111; border-radius:8px; padding:10px; margin:8px 0; }
.wait-player-list { margin:12px 0; display:flex; flex-direction:column; gap:6px; }
.wait-player { display:flex; align-items:center; gap:8px; background:#111; border-radius:8px; padding:8px 12px; }
.game-wrap { display:flex; flex-direction:column; gap:8px; }
.top-bar { display:flex; justify-content:space-between; align-items:center; background:#0d0d0d; border-radius:8px; padding:8px 12px; }
.pot-display { font-size:1.1rem; font-weight:700; color:#d4a017; }
.phase-badge { font-size:0.65rem; font-weight:700; letter-spacing:2px; padding:4px 8px; border-radius:6px; background:#1a3a1a; color:#4dff88; }
.phase-badge.badugi { background:#001a15; color:#22ccaa; }
.players-row { display:flex; gap:6px; overflow-x:auto; padding-bottom:4px; }
.player-chip { background:#0d0d0d; border:1px solid #2a2a2a; border-radius:10px; padding:6px 10px; text-align:center; min-width:70px; flex-shrink:0; }
.player-chip.active-turn { border-color:#d4a017; box-shadow:0 0 8px rgba(212,160,23,0.3); }
.player-chip.folded { opacity:0.4; }
.player-chip .pc-av { font-size:1.2rem; }
.player-chip .pc-name { font-size:0.62rem; color:#888; margin-top:2px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:60px; }
.player-chip .pc-chips { font-size:0.7rem; color:#d4a017; }
.player-chip .pc-bet { font-size:0.62rem; color:#4dff88; }
.player-chip .pc-decl { font-size:0.6rem; margin-top:2px; }
.board-section { background:#0a150a; border:1px solid #1a2a1a; border-radius:10px; padding:10px; }
.board-label { font-size:0.6rem; color:#555; letter-spacing:2px; margin-bottom:6px; }
.cols-row { display:flex; gap:4px; justify-content:center; overflow-x:auto; padding-bottom:4px; }
.col-group { display:flex; flex-direction:column; gap:4px; align-items:center; }
.col-label { font-size:0.55rem; color:#444; letter-spacing:1px; }
.card { border-radius:6px; display:flex; flex-direction:column; justify-content:space-between; align-items:center; position:relative; user-select:none; width:44px; height:62px; padding:2px; }
.card-face { background:linear-gradient(135deg,#c8960c,#f0c93a,#c8960c); color:#1a0a00; border:1px solid #a07010; box-shadow:inset 0 0 8px rgba(255,255,255,0.2); }
.card-face.red { color:#6b0000; }
.card-back { background:repeating-linear-gradient(45deg,#1a0a2a,#1a0a2a 4px,#2a1a3a 4px,#2a1a3a 8px); border:1px solid #333; }
.card-brand { position:absolute; top:4px; left:50%; transform:translateX(-50%); font-family:Arial,sans-serif; font-size:0.5rem; font-weight:900; letter-spacing:1px; color:rgba(80,40,0,0.45); white-space:nowrap; pointer-events:none; z-index:2; }
.card-face.sel { outline:3px solid #d4a017; }
.card-face.tap { cursor:pointer; }
.card-face.glow { box-shadow:0 0 8px rgba(212,160,23,0.6); }
.card-top { font-size:0.6rem; font-weight:700; line-height:1.1; align-self:flex-start; width:100%; }
.card-mid { font-size:0.95rem; font-weight:900; }
.card-suit { font-size:0.6rem; align-self:flex-end; width:100%; text-align:right; }
.card-sm { width:32px; height:44px; padding:2px; font-size:0.6rem; font-weight:700; display:flex; align-items:center; justify-content:center; }
.hole-cards-section { background:#0d0d0d; border:1px solid #2a2a2a; border-radius:10px; padding:10px; }
.hole-label { font-size:0.6rem; color:#555; letter-spacing:2px; margin-bottom:6px; display:flex; justify-content:space-between; }
.hole-cards-row { display:flex; gap:6px; justify-content:center; flex-wrap:wrap; }
.best-hand-bar { background:#0d1a0d; border:1px solid #1a3a1a; border-radius:8px; padding:6px 10px; font-size:0.7rem; }
.bh-label { color:#555; letter-spacing:1px; font-size:0.6rem; }
.bh-name { color:#4dff88; font-weight:700; }
.bh-cards { color:#aaa; font-size:0.65rem; margin-top:2px; }
.badugi-hand-bar { background:#001a15; border:1px solid #115544; border-radius:8px; padding:6px 10px; font-size:0.7rem; }
.bdg-valid { color:#22ccaa; font-weight:700; }
.bdg-invalid { color:#ff6644; font-weight:700; }
.action-section { background:#0d0d0d; border:1px solid #2a2a2a; border-radius:10px; padding:10px; }
.action-label { font-size:0.6rem; color:#555; letter-spacing:2px; margin-bottom:8px; }
.action-btns { display:flex; gap:6px; flex-wrap:wrap; }
.action-btns .btn { flex:1; min-width:70px; padding:10px 8px; font-size:0.75rem; margin-bottom:0; }
.bet-row { display:flex; gap:8px; align-items:center; margin-top:10px; flex-wrap:wrap; }
.bet-slider { flex:1; min-width:120px; accent-color:#d4a017; cursor:pointer; } .bet-val { font-size:1rem; color:#d4a017; font-weight:700; min-width:40px; text-align:center; }

.log-section { background:#080f08; border:1px solid #1a2a1a; border-radius:8px; padding:8px 10px; max-height:100px; overflow-y:auto; }
.log-line { font-size:0.68rem; color:#666; padding:2px 0; border-bottom:1px solid #0f1a0f; }
.log-line.imp { color:#d4a017; }
.log-line.win { color:#4dff88; font-weight:700; }
.log-line.act { color:#888; }
.chat-row { display:flex; gap:6px; margin-top:6px; }
.chat-input { flex:1; background:#111; border:1px solid #333; color:#f0e6c8; font-size:0.85rem; padding:8px; border-radius:8px; outline:none; }
.draw-round-bar { text-align:center; background:#001a15; border:1px solid #115544; border-radius:8px; padding:6px; font-size:0.75rem; color:#22ccaa; letter-spacing:1px; }
.modal-bg { position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.85); display:flex; align-items:center; justify-content:center; z-index:100; }
.modal-box { background:#0d0d0d; border:1px solid #d4a017; border-radius:14px; padding:24px; max-width:340px; width:90%; text-align:center; }
.modal-box h2 { color:#d4a017; font-size:1.2rem; letter-spacing:3px; margin-bottom:16px; }
.modal-line { padding:8px; border-radius:6px; margin-bottom:6px; font-size:0.85rem; }
.m-win { background:#0d2a0d; color:#4dff88; }
.m-info { background:#1a1400; color:#d4a017; }
.your-turn-flash { animation:flash 1s infinite; }
@keyframes flash { 0%,100%{opacity:1} 50%{opacity:0.5} }
.rebuy-modal { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; align-items:center; justify-content:center; z-index:200; }
.rebuy-box { background:#0d0d0d; border:2px solid #d4a017; border-radius:14px; padding:28px; max-width:300px; width:90%; text-align:center; }
.rebuy-box h2 { font-family:'Bebas Neue',sans-serif; color:#d4a017; font-size:1.8rem; letter-spacing:4px; margin-bottom:8px; }
.rebuy-box p { color:#888; font-size:0.85rem; margin-bottom:20px; line-height:1.5; }
.rebuy-chips { font-size:2rem; margin-bottom:16px; }
</style>
</head>
<body>
<div id="app">
<div id="screen-auth" class="screen active">
  <div class="hdr"><h1>‚õì CHAIN GANG ‚õì</h1><p>THE ORIGINAL YARD GAME</p></div>
  <div class="auth-box" id="login-box">
    <h2>SIGN IN</h2>
    <div class="field"><label>USERNAME</label><input id="l-user" placeholder="your name" autocomplete="username"></div>
    <div class="field"><label>PASSWORD</label><input id="l-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password"></div>
    <button class="btn btn-gold" onclick="doLogin()">SIGN IN</button>
    <div id="l-err" class="err"></div>
    <div class="toggle-auth">No account? <a onclick="showReg()">Register here</a></div>
  </div>
  <div class="auth-box" id="reg-box" style="display:none">
    <h2>CREATE ACCOUNT</h2>
    <div class="field"><label>USERNAME</label><input id="r-user" placeholder="choose a name" autocomplete="username"></div>
    <div class="field"><label>PASSWORD</label><input id="r-pass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="new-password"></div>
    <div class="field"><label>PICK YOUR AVATAR</label>
      <div class="avatar-grid" id="av-grid"></div>
    </div>
    <button class="btn btn-gold" onclick="doRegister()">CREATE ACCOUNT</button>
    <div id="r-err" class="err"></div>
    <div class="toggle-auth">Have an account? <a onclick="showLogin()">Sign in</a></div>
  </div>
</div>

<div id="screen-lobby" class="screen">
  <div class="hdr"><h1>‚õì CHAIN GANG ‚õì</h1><p>THE ORIGINAL YARD GAME</p></div>
  <div class="lobby-header">
    <div class="user-pill">
      <div class="av" id="lb-avatar">üé¥</div>
      <div class="info">
        <div class="uname" id="lb-username">Player</div>
        <div class="uchips" id="lb-chips">$1000 chips</div>
      </div>
    </div>
    <a href="/howtoplay.html" class="btn btn-gray btn-sm" style="text-decoration:none">HOW TO PLAY</a> <button class="btn btn-outline btn-sm" onclick="doLogout()">LOGOUT</button>
  </div>
  <div class="game-chooser">
    <h3>CHOOSE YOUR GAME</h3>
    <div class="game-tabs">
      <div class="game-tab active-tab" id="tab-chaingang" onclick="selectGame('chaingang')">
        <div class="gt-icon">‚õì</div>
        <div class="gt-name" style="color:#d4a017">CHAIN GANG</div>
        <div style="font-size:0.6rem;color:#666;margin-top:2px">5 card draw</div>
      </div>
      <div class="game-tab" id="tab-badugi" onclick="selectGame('badugi')">
        <div class="gt-icon">üé¥</div>
        <div class="gt-name" style="color:#22ccaa">BADUGI</div>
        <div style="font-size:0.6rem;color:#666;margin-top:2px">4 card, 3 draws</div>
      </div>
      <div class="game-tab" id="tab-1333" onclick="selectGame('1333')">
        <div class="gt-icon">üé≤</div>
        <div class="gt-name" style="color:#ff8844">13/33</div>
        <div style="font-size:0.6rem;color:#666;margin-top:2px">hit or stay</div>
      </div>
    </div>
  </div>
  <div class="lobby-btns">
    <div class="lobby-btn" id="play-now-btn" onclick="joinPublic()">
      <div class="lbicon">üåç</div>
      <div class="lbtitle" id="play-now-title">PLAY NOW</div>
      <div class="lbdesc" id="play-now-desc">Jump into a table with players worldwide</div>
    </div>
    <div class="lobby-btn" onclick="createPrivate()">
      <div class="lbicon">üîí</div>
      <div class="lbtitle">PRIVATE TABLE</div>
      <div class="lbdesc">Create a table, share the code with your crew</div>
    </div>
    <div>
      <div class="lbdesc" style="margin-bottom:6px;color:#666">Have a code? Enter it below:</div>
      <div class="code-input-row">
        <input class="code-input" id="join-code" placeholder="ABC123" maxlength="6">
        <button class="btn btn-gold btn-sm" onclick="joinPrivate()">JOIN</button>
      </div>
    </div>
  </div>
  <div id="lb-err" class="err" style="margin-top:8px"></div>
</div>

<div id="screen-waiting" class="screen">
  <div class="hdr"><h1>‚õì CHAIN GANG ‚õì</h1></div>
  <div class="waiting-box">
    <div class="w-icon">‚è≥</div>
    <h3 id="wait-title">WAITING FOR PLAYERS</h3>
    <p id="wait-msg">Finding opponents...</p>
    <div id="private-code-section" style="display:none">
      <p>Share this code with your friends:</p>
      <div class="private-code" id="room-code-display"></div>
      <p style="font-size:0.7rem;color:#555;margin-top:6px">They tap Private Table ‚Üí enter code ‚Üí join</p>
    </div>
    <div id="wait-players"></div>
    <button class="btn btn-gray btn-sm" style="margin-top:14px;width:auto" onclick="leaveRoom()">LEAVE TABLE</button>
  </div>
</div>

<div id="screen-game" class="screen">
  <div id="game-content"></div>
</div>

</div>

<div class="rebuy-modal" id="rebuy-modal" style="display:none">
  <div class="rebuy-box">
    <div class="rebuy-chips">üí∏</div>
    <h2>BROKE!</h2>
    <p id="rebuy-msg">You're out of chips. Rebuy to keep playing.</p>
    <button class="btn btn-gold" onclick="doRebuy(500)">REBUY $500</button>
    <button class="btn btn-green" style="margin-top:8px" onclick="doRebuy(1000)">REBUY $1000</button>
    <button class="btn btn-gray" style="margin-top:8px" onclick="closeRebuy()">LEAVE TABLE</button>
  </div>
</div>

<div class="modal-bg" id="showdown-modal" style="display:none">
  <div class="modal-box">
    <h2>üèÜ SHOWDOWN</h2>
    <div id="sd-content"></div>
    <button class="btn btn-gold" style="margin-top:14px" onclick="document.getElementById('showdown-modal').style.display='none'">OK</button>
  </div>
</div>
<script>
let token = localStorage.getItem('cgp_token');
let me = null;
let socket = null;
let currentRoomId = null;
let selectedDraw = [];
let betVal = 20;
let selectedGame = 'chaingang';

const AVATARS = ['üòé','ü§†','üëª','ü§ñ','ü¶ä','üêª','ü¶Å','üêØ','üé≠','üÉè','üé∞','üíÄ','üß†','üëë','üî•','‚ö°'];

function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
}
function showLogin() {
  document.getElementById('login-box').style.display = '';
  document.getElementById('reg-box').style.display = 'none';
}
function showReg() {
  document.getElementById('login-box').style.display = 'none';
  document.getElementById('reg-box').style.display = '';
  const grid = document.getElementById('av-grid');
  if (!grid.children.length) {
    grid.innerHTML = AVATARS.map((a,i) => `<div class="av-opt" onclick="pickAv(this,'${a}')">${a}</div>`).join('');
  }
}
function pickAv(el, av) {
  document.querySelectorAll('.av-opt').forEach(e => e.classList.remove('selected'));
  el.classList.add('selected');
  el.dataset.av = av;
}
function getSelectedAv() {
  const sel = document.querySelector('.av-opt.selected');
  return sel ? sel.dataset.av || sel.textContent : 'üé¥';
}
function selectGame(game) {
  selectedGame = game;
  document.getElementById('tab-chaingang').classList.remove('active-tab','badugi-active');
  document.getElementById('tab-badugi').classList.remove('active-tab','badugi-active');
  if (game === 'chaingang') {
    document.getElementById('tab-chaingang').classList.add('active-tab');
    document.getElementById('play-now-title').textContent = 'PLAY NOW';
    document.getElementById('play-now-desc').textContent = 'Jump into a Chain Gang table';
  } else if (game === 'badugi') {
    document.getElementById('tab-badugi').classList.add('badugi-active');
    document.getElementById('play-now-title').textContent = 'PLAY BADUGI';
    document.getElementById('play-now-desc').textContent = 'Jump into a Badugi table';
  } else {
    document.getElementById('tab-1333').classList.add('active-tab');
    document.getElementById('tab-1333').style.borderColor='#ff8844';
    document.getElementById('play-now-title').textContent = 'PLAY 13/33';
    document.getElementById('play-now-desc').textContent = 'Jump into a 13/33 table';
  }
}
async function doLogin() {
  const username = document.getElementById('l-user').value.trim();
  const password = document.getElementById('l-pass').value;
  if (!username || !password) { document.getElementById('l-err').textContent='Fill in all fields'; return; }
  try {
    const res = await fetch('/api/login', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password}) });
    const data = await res.json();
    if (!res.ok) { document.getElementById('l-err').textContent = data.error || 'Login failed'; return; }
    token = data.token; me = data.user;
    localStorage.setItem('cgp_token', token);
    enterLobby();
  } catch(e) { document.getElementById('l-err').textContent = 'Server error. Try again.'; }
}
async function doRegister() {
  const username = document.getElementById('r-user').value.trim();
  const password = document.getElementById('r-pass').value;
  const avatar = getSelectedAv();
  if (!username || !password) { document.getElementById('r-err').textContent='Fill in all fields'; return; }
  try {
    const res = await fetch('/api/register', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({username,password,avatar}) });
    const data = await res.json();
    if (!res.ok) { document.getElementById('r-err').textContent = data.error || 'Register failed'; return; }
    token = data.token; me = data.user;
    localStorage.setItem('cgp_token', token);
    enterLobby();
  } catch(e) { document.getElementById('r-err').textContent = 'Server error. Try again.'; }
}
function doLogout() {
  localStorage.removeItem('cgp_token');
  token = null; me = null;
  if (socket) { socket.disconnect(); socket = null; }
  showScreen('auth');
}
function enterLobby() {
  document.getElementById('lb-avatar').textContent = me.avatar;
  document.getElementById('lb-username').textContent = me.displayName;
  document.getElementById('lb-chips').textContent = '$' + me.chips + ' chips';
  showScreen('lobby');
  initSocket();
}
function joinPublic() {
  document.getElementById('lb-err').textContent = '';
  socket.emit('joinPublic', { gameType: selectedGame });
}
function createPrivate() { socket.emit('createPrivate', { gameType: selectedGame }); }
function joinPrivate() {
  const code = document.getElementById('join-code').value.trim().toUpperCase();
  if (!code) { document.getElementById('lb-err').textContent='Enter a room code'; return; }
  socket.emit('joinPrivate', { code });
}
function leaveRoom() {
  if (socket && currentRoomId) { socket.emit('leaveRoom'); }
  currentRoomId = null;
  showScreen('lobby');
}
function initSocket() {
  if (socket) return;
  socket = io();
  socket.on('connect', () => { if (token) socket.emit('auth', { token }); });
  socket.on('authOk', user => { me = user; });
  socket.on('authError', msg => { alert('Auth error: ' + msg); doLogout(); });
  socket.on('joinedRoom', ({ roomId, isPrivate, gameType }) => {
    currentRoomId = roomId;
    selectedDraw = [];
    document.getElementById('private-code-section').style.display = isPrivate ? '' : 'none';
    if (isPrivate) document.getElementById('room-code-display').textContent = roomId;
    document.getElementById('wait-msg').textContent = isPrivate ? 'Waiting for your crew...' : 'Finding opponents...';
    document.getElementById('wait-title').textContent = gameType === 'badugi' ? 'üé¥ BADUGI TABLE' : '‚õì CHAIN GANG TABLE';
    showScreen('waiting');
  });
  socket.on('privateCode', code => { document.getElementById('room-code-display').textContent = code; });
  socket.on('lobbyError', msg => { document.getElementById('lb-err').textContent = msg; });
  socket.on('gameState', state => {
    if (state.phase === 'waiting') {
      renderWaiting(state);
      showScreen('waiting');
    } else {
      document.getElementById('showdown-modal').style.display = 'none';
      renderGame(state);
      showScreen('game');
      if (state.phase === 'showdown') renderShowdown(state);
    }
  });
  socket.on('chat', ({ from, avatar, msg }) => {
    const box = document.getElementById('chat-log');
    if (!box) return;
    const line = document.createElement('div');
    line.className = 'log-line';
    line.textContent = avatar + ' ' + from + ': ' + msg;
    box.insertBefore(line, box.firstChild);
  });
  socket.on('error', msg => { alert(msg); });
}
function renderWaiting(state) {
  const el = document.getElementById('wait-players');
  el.innerHTML = '<div class="wait-player-list">' +
    state.players.map(p => '<div class="wait-player"><span>' + p.avatar + '</span><span>' + escHtml(p.displayName) + '</span><span style="color:#d4a017;font-size:0.75rem">$' + p.chips + '</span></div>').join('') +
    '</div>';
}
function renderGame(state) {
  if (state.gameType === 'badugi') renderBadugi(state);
  else if (state.gameType === '1333') render1333(state);
  else renderChainGang(state);
  checkRebuy(state);
}
function phaseLabel(phase) {
  const labels = {ante:'ANTE',draw:'DRAW',bet1:'BET 1',bet2:'BET 2',bet3:'BET 3',decl:'DECLARE',showdown:'SHOWDOWN',bbet:'BETTING',fbet:'FINAL BET',bet:'BETTING',hit:'HIT OR STAY'};
  return labels[phase] || phase.toUpperCase();
}
function renderPlayers(state) {
  return state.players.map((p,i) => {
    const isActive = i === state.currentTurn && !['ante','waiting','showdown'].includes(state.phase);
    const declIcon = p.decl === 'hidden' ? 'üîí' : p.decl === 'high' ? '‚¨ÜÔ∏è' : p.decl === 'low' ? '‚¨áÔ∏è' : p.decl === 'swing' ? '‚ÜïÔ∏è' : '';
    return '<div class="player-chip' + (isActive?' active-turn':'') + (p.folded?' folded':'') + '">' +
      '<div class="pc-av">' + p.avatar + (p.isMe ? '‚≠ê' : '') + '</div>' +
      '<div class="pc-name">' + escHtml(p.displayName) + '</div>' +
      '<div class="pc-chips">$' + p.chips + '</div>' +
      (p.bet > 0 ? '<div class="pc-bet">bet $' + p.bet + '</div>' : '') +
      (declIcon ? '<div class="pc-decl">' + declIcon + '</div>' : '') +
      (p.drawDone ? '<div style="font-size:0.6rem;color:#22ccaa">‚úì drew</div>' : '') +
      '</div>';
  }).join('');
}
function renderChainGang(state) {
  const myTurn = state.players[state.currentTurn]?.isMe;
  const isBettingPhase = ['bet1','bet2','bet3'].includes(state.phase);
  const isFolded = state.myFolded;
  let boardHtml = '';
  if (state.cols && state.cols.length) {
    boardHtml = '<div class="board-section"><div class="board-label">COMMUNITY BOARD</div><div class="cols-row">' +
      state.cols.map((col, i) => {
        return '<div class="col-group"><div class="col-label">COL ' + (i+1) + '</div>' +
          '<div style="display:flex;gap:3px">' + cardSmallHtml(col.pair[0]) + cardSmallHtml(col.pair[1]) + '</div>' +
          cardSmallHtml(col.single, i===2 && ['decl','bet3','showdown'].includes(state.phase)) +
          '</div>';
      }).join('') + '</div></div>';
  }
  let holeHtml = '';
  if (state.myHand && state.myHand.length) {
    const canDraw = state.phase === 'draw' && !isFolded;
    holeHtml = '<div class="hole-cards-section"><div class="hole-label"><span>YOUR HAND</span>' +
      (canDraw ? '<span style="color:#d4a017">Tap to select (max 2)</span>' : '') +
      '</div><div class="hole-cards-row" id="hole-cards-row">' +
      state.myHand.map((c,i) => {
        const sel = state.mySelectedDraw && state.mySelectedDraw.includes(i);
        return cardHtml(c, sel, canDraw ? 'tapCard(' + i + ')' : null);
      }).join('') + '</div></div>';
  }
  let bestHtml = '';
  if (state.myBestHand && state.myBestHand.highName) {
    bestHtml = '<div class="best-hand-bar"><div class="bh-label">BEST POSSIBLE HAND</div>' +
      '<div class="bh-name">' + escHtml(state.myBestHand.highName) + '</div>' +
      (state.myBestHand.hasLow ? '<div class="bh-cards">Low: ' + escHtml(state.myBestHand.lowCards.join(' ')) + '</div>' : '') +
      '</div>';
  }
  let actionHtml = '';
  if (!isFolded) {
    if (state.phase === 'ante') {
      actionHtml = '<div class="action-section"><div class="action-label">POST ANTE $' + state.ante + '</div><div class="action-btns"><button class="btn btn-gold" onclick="doAnte()">POST ANTE</button></div></div>';
    } else if (state.phase === 'draw') {
      actionHtml = '<div class="action-section"><div class="action-label">DRAW PHASE ‚Äî SELECT CARDS TO SWAP (MAX 2)</div><div class="action-btns"><button class="btn btn-green" onclick="doDraw()">CONFIRM DRAW</button></div></div>';
    } else if (isBettingPhase && myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label">YOUR TURN ‚Äî BET</div><div class="action-btns">' +
        (state.currentBet === 0 ? '<button class="btn btn-blue" onclick="doCheck()">CHECK</button>' : '') +
        (state.currentBet > 0 ? '<button class="btn btn-blue" onclick="doCall()">CALL $' + state.currentBet + '</button>' : '') +
        '<button class="btn btn-green" onclick="doRaise()">RAISE</button>' +
        '<button class="btn btn-red" onclick="doFold()">FOLD</button>' +
        '</div><div class="bet-row"><input type="range" id="bet-input" class="bet-slider" min="1" max="'+(state.phase==="bet3"?25:15)+'" value="'+Math.min(betVal,(state.phase==="bet3"?25:15))+'" oninput="betVal=+this.value;var d=document.getElementById("bet-display");if(d)d.textContent="$"+this.value"><span class="bet-val" id="bet-display">$'+Math.min(betVal,(state.phase==="bet3"?25:15))+'</span><button class="btn btn-gold btn-sm" onclick="doRaise()">RAISE</button></div></div>';
    } else if (isBettingPhase && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR ' + escHtml(state.players[state.currentTurn]?.displayName || '...') + ' TO BET</div></div>';
    } else if (state.phase === 'decl' && myTurn && !state.myDecl) {
      actionHtml = '<div class="action-section"><div class="action-label your-turn-flash">YOUR TURN ‚Äî DECLARE</div><div class="action-btns">' +
        '<button class="btn btn-green" onclick="doDecl(\'high\')">HIGH ‚¨ÜÔ∏è</button>' +
        '<button class="btn btn-blue" onclick="doDecl(\'low\')">LOW ‚¨áÔ∏è</button>' +
        '<button class="btn btn-purple" onclick="doDecl(\'swing\')">SWING ‚ÜïÔ∏è</button>' +
        '</div></div>';
    } else if (state.phase === 'decl' && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR ' + escHtml(state.players[state.currentTurn]?.displayName || '...') + ' TO DECLARE</div></div>';
    } else if (state.phase === 'decl' && state.myDecl) {
      actionHtml = '<div class="action-section"><div class="action-label">YOU DECLARED: ' + state.myDecl.toUpperCase() + '</div></div>';
    }
  } else {
    actionHtml = '<div class="action-section"><div class="action-label" style="color:#666">YOU FOLDED</div></div>';
  }
  const logHtml = '<div class="log-section" id="chat-log">' +
    (state.log||[]).map(l => '<div class="log-line ' + l.type + '">' + escHtml(l.msg) + '</div>').join('') + '</div>';
  document.getElementById('game-content').innerHTML = '<div class="game-wrap">' +
    '<div class="top-bar"><span class="pot-display">POT: $' + state.pot + '</span>' +
    '<span class="phase-badge">' + phaseLabel(state.phase) + '</span>' +
    '<button class="btn btn-gray btn-sm" onclick="leaveRoom()">LEAVE</button></div>' +
    '<div class="players-row">' + renderPlayers(state) + '</div>' +
    boardHtml + holeHtml + bestHtml + actionHtml + logHtml +
    '<div class="chat-row"><input class="chat-input" id="chat-input" placeholder="Say something..." maxlength="100" onkeydown="if(event.key===\'Enter\')sendChat()"><button class="btn btn-gray btn-sm" onclick="sendChat()">SEND</button></div>' +
    '</div>';
}
function renderBadugi(state) {
  const myTurn = state.players[state.currentTurn]?.isMe;
  const isFolded = state.myFolded;
  const isBettingPhase = ['bbet','fbet'].includes(state.phase);
  let holeHtml = '';
  if (state.myHand && state.myHand.length) {
    const canDraw = state.phase === 'draw' && !isFolded;
    holeHtml = '<div class="hole-cards-section"><div class="hole-label"><span>YOUR HAND</span>' +
      (canDraw ? '<span style="color:#22ccaa">Tap to swap (any cards)</span>' : '') +
      '</div><div class="hole-cards-row" id="hole-cards-row">' +
      state.myHand.map((c,i) => {
        const sel = state.mySelectedDraw && state.mySelectedDraw.includes(i);
        return cardHtml(c, sel, canDraw ? 'tapCardBadugi(' + i + ')' : null);
      }).join('') + '</div></div>';
  }
  let badugiHtml = '';
  if (state.myBadugiHand) {
    const b = state.myBadugiHand;
    if (b.isValid) {
      badugiHtml = '<div class="badugi-hand-bar"><span class="bdg-valid">‚úÖ BADUGI!</span> <span style="color:#aaa;font-size:0.7rem">' + b.cards.join(' ') + '</span></div>';
    } else {
      badugiHtml = '<div class="badugi-hand-bar"><span class="bdg-invalid">‚ùå NOT A BADUGI</span> <span style="color:#666;font-size:0.65rem">Need 4 diff suits + ranks</span></div>';
    }
  }
  let drawRoundHtml = '';
  if (state.drawRound > 0) {
    drawRoundHtml = '<div class="draw-round-bar">DRAW ROUND ' + state.drawRound + ' OF 3</div>';
  }
  let actionHtml = '';
  if (!isFolded) {
    if (state.phase === 'ante') {
      actionHtml = '<div class="action-section"><div class="action-label">POST ANTE $' + state.ante + '</div><div class="action-btns"><button class="btn btn-teal" onclick="doAnte()">POST ANTE</button></div></div>';
    } else if (state.phase === 'draw') {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#22ccaa">SELECT CARDS TO SWAP (ANY OR NONE)</div><div class="action-btns"><button class="btn btn-teal" onclick="doDraw()">CONFIRM DRAW</button></div></div>';
    } else if (isBettingPhase && myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label">YOUR TURN ‚Äî BET</div><div class="action-btns">' +
        (state.currentBet === 0 ? '<button class="btn btn-blue" onclick="doCheck()">CHECK</button>' : '') +
        (state.currentBet > 0 ? '<button class="btn btn-blue" onclick="doCall()">CALL $' + state.currentBet + '</button>' : '') +
        '<button class="btn btn-green" onclick="doRaise()">RAISE</button>' +
        '<button class="btn btn-red" onclick="doFold()">FOLD</button>' +
        '</div><div class="bet-row"><input type="range" id="bet-input" class="bet-slider" min="1" max="'+(state.phase==="fbet"?25:15)+'" value="'+Math.min(betVal,(state.phase==="fbet"?25:15))+'" oninput="betVal=+this.value;var d=document.getElementById("bet-display");if(d)d.textContent="$"+this.value"><span class="bet-val" id="bet-display">$'+Math.min(betVal,(state.phase==="fbet"?25:15))+'</span><button class="btn btn-gold btn-sm" onclick="doRaise()">RAISE</button></div></div>';
    } else if (isBettingPhase && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR ' + escHtml(state.players[state.currentTurn]?.displayName || '...') + ' TO BET</div></div>';
    } else if (state.phase === 'decl' && myTurn && !state.myDecl) {
      actionHtml = '<div class="action-section"><div class="action-label your-turn-flash" style="color:#22ccaa">YOUR TURN ‚Äî DECLARE</div><div class="action-btns">' +
        '<button class="btn btn-green" onclick="doDecl(\'high\')">HIGH ‚¨ÜÔ∏è</button>' +
        '<button class="btn btn-blue" onclick="doDecl(\'low\')">LOW ‚¨áÔ∏è</button>' +
        '</div></div>';
    } else if (state.phase === 'decl' && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR ' + escHtml(state.players[state.currentTurn]?.displayName || '...') + ' TO DECLARE</div></div>';
    } else if (state.phase === 'decl' && state.myDecl) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#22ccaa">YOU DECLARED: ' + state.myDecl.toUpperCase() + '</div></div>';
    }
  } else {
    actionHtml = '<div class="action-section"><div class="action-label" style="color:#666">YOU FOLDED</div></div>';
  }
  const logHtml = '<div class="log-section" id="chat-log">' +
    (state.log||[]).map(l => '<div class="log-line ' + l.type + '">' + escHtml(l.msg) + '</div>').join('') + '</div>';
  document.getElementById('game-content').innerHTML = '<div class="game-wrap">' +
    '<div class="top-bar"><span class="pot-display">POT: $' + state.pot + '</span>' +
    '<span class="phase-badge badugi">' + phaseLabel(state.phase) + '</span>' +
    '<button class="btn btn-gray btn-sm" onclick="leaveRoom()">LEAVE</button></div>' +
    '<div class="players-row">' + renderPlayers(state) + '</div>' +
    drawRoundHtml + holeHtml + badugiHtml + actionHtml + logHtml +
    '<div class="chat-row"><input class="chat-input" id="chat-input" placeholder="Say something..." maxlength="100" onkeydown="if(event.key===\'Enter\')sendChat()"><button class="btn btn-gray btn-sm" onclick="sendChat()">SEND</button></div>' +
    '</div>';
}
function renderShowdown(state) {
  const modal = document.getElementById('showdown-modal');
  const content = document.getElementById('sd-content');
  const lines = (state.log || []).filter(l => l.type === 'win' || (l.type === 'imp' && (l.msg.includes('Factor') || l.msg.includes('badugi'))));
  let html = '';
  lines.forEach(l => {
    html += '<div class="modal-line ' + (l.type === 'win' ? 'm-win' : 'm-info') + '">' + escHtml(l.msg) + '</div>';
  });
  content.innerHTML = html || '<div class="modal-line m-info">Hand complete.</div>';
  modal.style.display = 'flex';
}
function cardHtml(card, selected, onclickFn) {
  if (!card) return '<div class="card card-back"></div>';
  const red = (card.s === '‚ô•' || card.s === '‚ô¶') ? ' red' : '';
  const selC = selected ? ' sel' : '';
  const tapC = onclickFn ? ' tap' : '';
  const oc = onclickFn ? 'onclick="' + onclickFn + '"' : '';
  return '<div class="card card-face' + red + selC + tapC + '" ' + oc + '>' +
    '<div class="card-brand">DGM$</div>' +
    '<div class="card-top">' + card.v + '<br>' + card.s + '</div>' +
    '<div class="card-mid">' + card.v + '</div>' +
    '<div class="card-suit">' + card.s + '</div>' +
    '</div>';
}
function cardSmallHtml(card, glow) {
  if (!card) return '<div class="card card-sm card-back"></div>';
  const red = (card.s === '‚ô•' || card.s === '‚ô¶') ? ' red' : '';
  const glowC = glow ? ' glow' : '';
  return '<div class="card card-sm card-face' + red + glowC + '">' + '<div style="font-size:0.28rem;font-weight:900;color:rgba(80,40,0,0.3);line-height:1">DGM$</div>' + card.v + card.s + '</div>';
}
function doAnte() { socket.emit('ante'); }
function tapCard(i) {
  const idx = selectedDraw.indexOf(i);
  if (idx >= 0) selectedDraw.splice(idx, 1);
  else if (selectedDraw.length < 2) selectedDraw.push(i);
  socket.emit('selectDraw', { selected: selectedDraw });
  document.querySelectorAll('#hole-cards-row .card').forEach((el, ci) => {
    if (selectedDraw.includes(ci)) el.classList.add('sel');
    else el.classList.remove('sel');
  });
}
function tapCardBadugi(i) {
  const idx = selectedDraw.indexOf(i);
  if (idx >= 0) selectedDraw.splice(idx, 1);
  else selectedDraw.push(i);
  socket.emit('selectDraw', { selected: selectedDraw });
  document.querySelectorAll('#hole-cards-row .card').forEach((el, ci) => {
    if (selectedDraw.includes(ci)) el.classList.add('sel');
    else el.classList.remove('sel');
  });
}
function doDraw() {
  socket.emit('confirmDraw', { selected: selectedDraw });
  selectedDraw = [];
}
function doCheck() { socket.emit('betAction', { action: 'check' }); }
function doCall() { socket.emit('betAction', { action: 'call' }); }
function doRaise() {
  const v = parseInt(document.getElementById('bet-input')?.value || betVal);
  betVal = v;
  socket.emit('betAction', { action: 'raise', amount: v });
}
function doFold() { socket.emit('betAction', { action: 'fold' }); }
function doDecl(d) { socket.emit('declare', { decl: d }); }
function sendChat() {
  const inp = document.getElementById('chat-input');
  if (!inp || !inp.value.trim()) return;
  socket.emit('chat', { msg: inp.value.trim() });
  inp.value = '';
}
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}
(async function() {
  if (!token) return;
  try {
    const res = await fetch('/api/profile', { headers: { Authorization: 'Bearer ' + token } });
    if (!res.ok) { localStorage.removeItem('cgp_token'); return; }
    me = await res.json();
    enterLobby();
  } catch(e) {
    localStorage.removeItem('cgp_token');
    token = null;
  }
})();

function render1333(state) {
  const myTurn = state.players[state.currentTurn]?.isMe;
  const isFolded = state.myFolded;
  const s = state.my1333Score;
  const color = s ? (s.madeLow ? '#4dff88' : s.madeHigh ? '#d4a017' : s.bust ? '#ff4422' : '#aaa') : '#aaa';
  const label = s ? (s.madeLow ? 'MADE LOW' : s.madeHigh ? 'MADE HIGH' : s.bust ? 'BUST' : 'In play') : '';
  const scoreHtml = s ? '<div style="background:#0d0d0d;border:1px solid #2a2a2a;border-radius:8px;padding:8px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center"><span style="font-size:0.7rem;color:#555;letter-spacing:2px">YOUR SCORE</span><span style="font-size:1.3rem;font-weight:700;color:'+color+'">'+s.score+' pts</span><span style="font-size:0.75rem;color:'+color+'">'+label+'</span></div>' : '';
  const myCardsHtml = state.myHand && state.myHand.length ? '<div class="hole-cards-section"><div class="hole-label"><span>YOUR CARDS</span></div><div class="hole-cards-row">' + state.myHand.map((card,i) => '<div>' + cardHtml(card,false,null) + '<div class="card-label">'+(i===0?'HOLE':'UP')+'</div></div>').join('') + '</div></div>' : '';
  const othersHtml = '<div class="players-row">' + state.players.map((p,i) => {
    const isActive = i===state.currentTurn && state.phase==='hit';
    const stayedBadge = p.stayed ? '<div style="font-size:0.6rem;color:#4dff88">STAYED</div>' : '';
    const scoreBadge = p.score1333!==null && p.score1333!==undefined ? '<div style="font-size:0.65rem;color:#d4a017">'+p.score1333+' pts</div>' : '';
    const visCards = p.visibleCards && p.visibleCards.length ? '<div style="display:flex;gap:2px;margin-top:4px;justify-content:center">'+p.visibleCards.map(vc=>cardSmallHtml(vc,false)).join('')+'</div>' : '';
    return '<div class="player-chip'+(isActive?' active-turn':'')+(p.folded?' folded':'')+'"><div class="pc-av">'+p.avatar+(p.isMe?'&#11088;':'')+'</div><div class="pc-name">'+escHtml(p.displayName)+'</div><div class="pc-chips">$'+p.chips+'</div>'+(p.bet>0?'<div class="pc-bet">bet $'+p.bet+'</div>':'')+stayedBadge+scoreBadge+visCards+'</div>';
  }).join('') + '</div>';
  let actionHtml = '';
  if (!isFolded) {
    if (state.phase==='ante') {
      actionHtml = '<div class="action-section"><div class="action-label">POST ANTE $1</div><div class="action-btns"><button class="btn btn-gold" onclick="doAnte()">POST ANTE</button></div></div>';
    } else if (state.phase==='bet' && myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label your-turn-flash">YOUR TURN ‚Äî BET ($1-$10)</div><div class="action-btns">'+(state.currentBet===0?'<button class="btn btn-blue" onclick="doCheck()">CHECK</button>':'')+(state.currentBet>0?'<button class="btn btn-blue" onclick="doCall()">CALL $'+state.currentBet+'</button>':'')+'<button class="btn btn-green" onclick="doRaise()">RAISE</button><button class="btn btn-red" onclick="doFold()">FOLD</button></div><div class="bet-row"><input type="range" id="bet-input" class="bet-slider" min="1" max="10" value="'+Math.min(betVal,10)+'" oninput="betVal=+this.value;var d=document.getElementById('bet-display');if(d)d.textContent='$'+this.value"><span class="bet-val" id="bet-display">$'+Math.min(betVal,10)+'</span></div></div>';
    } else if (state.phase==='bet' && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR '+escHtml(state.players[state.currentTurn]?.displayName||'...')+' TO BET</div></div>';
    } else if (state.phase==='hit' && myTurn && s && !s.bust) {
      actionHtml = '<div class="action-section"><div class="action-label your-turn-flash" style="color:#ff8844">HIT OR STAY? ('+s.score+' pts)</div><div class="action-btns"><button class="btn btn-green" onclick="doHit1333()">HIT</button><button class="btn btn-gold" onclick="doStay1333()">STAY</button><button class="btn btn-red" onclick="doFold()">FOLD</button></div></div>';
    } else if (state.phase==='hit' && !myTurn) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#888">WAITING FOR '+escHtml(state.players[state.currentTurn]?.displayName||'...')+' TO HIT OR STAY</div></div>';
    } else if (state.phase==='hit' && s && s.stayed) {
      actionHtml = '<div class="action-section"><div class="action-label" style="color:#4dff88">YOU STAYED</div></div>';
    }
  } else {
    actionHtml = '<div class="action-section"><div class="action-label" style="color:#666">YOU FOLDED</div></div>';
  }
  const logHtml = '<div class="log-section" id="chat-log">'+(state.log||[]).map(l=>'<div class="log-line '+l.type+'">'+escHtml(l.msg)+'</div>').join('')+'</div>';
  document.getElementById('game-content').innerHTML = '<div class="game-wrap"><div class="top-bar"><span class="pot-display">POT: $'+state.pot+'</span><span class="phase-badge" style="background:#1a0d00;color:#ff8844">'+phaseLabel(state.phase)+'</span><button class="btn btn-gray btn-sm" onclick="leaveRoom()">LEAVE</button></div>'+othersHtml+scoreHtml+myCardsHtml+actionHtml+logHtml+'<div class="chat-row"><input class="chat-input" id="chat-input" placeholder="Say something..." maxlength="100" onkeydown="if(event.key==='Enter')sendChat()"><button class="btn btn-gray btn-sm" onclick="sendChat()">SEND</button></div></div>';
}
function doHit1333() { socket.emit('hit1333'); }
function doStay1333() { socket.emit('stay1333'); }

function checkRebuy(state) {
  const me=state.players.find(p=>p.isMe);
  if(!me)return;
  if(me.chips<=0&&state.phase==='ante'){
    document.getElementById('rebuy-modal').style.display='flex';
  } else if(me.chips>0&&me.chips<=20&&state.phase==='ante'){
    const modal=document.getElementById('rebuy-modal');
    document.getElementById('rebuy-msg').textContent='Running low on chips ($'+me.chips+'). Top up to keep playing!';
    modal.style.display='flex';
  }
}
function doRebuy(amount) {
  socket.emit('rebuy',{amount});
  document.getElementById('rebuy-modal').style.display='none';
}
function closeRebuy() {
  document.getElementById('rebuy-modal').style.display='none';
  leaveRoom();
}
</script>
</body>
</html>
+me.chips+'). Top up to keep playing!';
    modal.style.display='flex';
  }
}
function doRebuy(amount) {
  socket.emit('rebuy',{amount});
  document.getElementById('rebuy-modal').style.display='none';
}
function closeRebuy() {
  document.getElementById('rebuy-modal').style.display='none';
  leaveRoom();
}
</script>
</body>
</html>
